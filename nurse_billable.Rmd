---
title: "nurse_billable.Rmd"
author: "Riya"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}

library(glue)
library(odbc)
library(tidyverse)
library(DBI)
library(pool)

conn1 <- dbConnect(odbc(), "OAO Cloud DB SoYoun", timeout = 15)

pb_nurse_tbl <- tbl(conn1, "V_PB_BILLABLE_NURSE_VISITS")
hb_nurse_tbl <- tbl(conn1, "V_HB_BILLABLE_NURSE_VISITS")
combined_billing_tbl <- tbl(conn1, "COMBINED_BILLING_DATA")
combined_billing_access_tbl <- tbl(conn1, "COMBINED_NURSE_BILLING_ACCESS_DATA")
eagle_data_tbl <- tbl(conn1, "EAGLE_DATA")


### Using union to append PB, HB and processed Eagle Data. 

billing_drop <- glue("DROP TABLE COMBINED_BILLING_DATA")
billing_query <- glue("CREATE TABLE COMBINED_BILLING_DATA AS
(SELECT NULL AS SITE, PAT_MRN_ID, PAT_NAME, SERVICE_DATE AS ORG_SERVICE_DATE, SERVICE_DATE AS DISCHARGE_DATE, POST_DATE, TX_TYPE AS TRANSACTION_TYPE, AMOUNT, DISCH_DEPT_ID AS DEPARTMENT_ID, DISCH_DEPT AS DEPARTMENT_NAME,
NULL AS SERIAL, HSP_ACCOUNT_ID, NULL AS EXTERNAL_VISIT_ID
FROM V_PB_BILLABLE_NURSE_VISITS)
UNION
(SELECT NULL AS SITE, PAT_MRN_ID, PAT_NAME, SERVICE_DATE AS ORG_SERVICE_DATE, SERVICE_DATE AS DISCHARGE_DATE, TX_POST_DATE AS POST_DATE, TX_TYPE AS TRANSACTION_TYPE, TX_AMOUNT AS AMOUNT,
DISCH_DEPT_ID AS DEPARTMENT_ID, DISCH_DEPT AS DEPARTMENT_NAME, NULL AS SERIAL, HSP_ACCOUNT_ID, NULL AS EXTERNAL_VISIT_ID
FROM V_HB_BILLABLE_NURSE_VISITS)
UNION
(SELECT SITE, PAT_MRN_ID, PAT_NAME, BGN_SERVICE_DATE AS ORG_SERVICE_DATE, DISCHARGE_DATE, BILLING_DATE AS POST_DATE, TRANSACTION_TYPE, AMOUNT, NULL AS DEPARTMENT_ID, NULL AS DEPARTMENT_NAME,
SERIAL, (CASE WHEN SITE IN ('BI','STLR') THEN SERIAL ELSE NULL END) AS HSP_ACCOUNT_ID, (CASE WHEN SITE IN ('MSH') THEN TO_CHAR(SERIAL) ELSE NULL END) AS EXTERNAL_VISIT_ID
FROM EAGLE_DATA);")

billing_index <- glue("CREATE index billing_index on COMBINED_BILLING_DATA (ORG_SERVICE_DATE, DISCHARGE_DATE, POST_DATE, DEPARTMENT_ID)")


### merging access, smartsetsid and billing data using left join

billing_access_drop <- glue("DROP TABLE COMBINED_NURSE_BILLING_ACCESS_DATA")
billing_access_query <- glue("CREATE TABLE COMBINED_NURSE_BILLING_ACCESS_DATA AS 
SELECT a.*, b.ORG_SERVICE_DATE, b.DISCHARGE_DATE, b.POST_DATE, b.TRANSACTION_TYPE, b.AMOUNT, 
b.DEPARTMENT_ID AS DUP_DEPT_ID, b.DEPARTMENT_NAME AS DUP_DEPT_NAME, b.SERIAL
FROM
(SELECT DISTINCT
MV_DM_PATIENT_ACCESS.MRN AS MRN_ID,
MV_DM_PATIENT_ACCESS.PAT_NAME AS PATIENT_NAME,
MV_DM_PATIENT_ACCESS.PAT_ENC_CSN_ID,
MV_DM_PATIENT_ACCESS.CONTACT_DATE,
MV_DM_PATIENT_ACCESS.LOS_NAME AS LEVEL_OF_SERVICE,
MV_DM_PATIENT_ACCESS.PRC_NAME,
MV_DM_PATIENT_ACCESS.SITE,
MV_DM_PATIENT_ACCESS.DEPARTMENT_ID,
MV_DM_PATIENT_ACCESS.DEPARTMENT_NAME,
MV_DM_PATIENT_ACCESS.DEPT_SPECIALTY_NAME,
MV_DM_PATIENT_ACCESS.REASON_FOR_VISIT AS REASON_VISIT_NAME,
MV_DM_PATIENT_ACCESS.DEP_RPT_GRP_TWELVE AS DEPARTMENT_TYPE,
MV_DM_PATIENT_ACCESS.HSP_ACCOUNT_ID,
MV_DM_PATIENT_ACCESS.EXTERNAL_VISIT_ID,
EPT_SEL_SMARTSETS.SELECTED_SSET_ID,
CASE WHEN EPT_SEL_SMARTSETS.SELECTED_SSET_ID = '5814' THEN 'Billable' ELSE 'Non-Billable' END AS BILLABLE_VS_NONBILLABLE,
CASE WHEN EPT_SEL_SMARTSETS.CONTACT_DATE IS NOT NULL THEN 'Yes' ELSE 'No' END AS NURSE_BILLABLE_VISIT_SMARTSET_USE_YES_NO
FROM MV_DM_PATIENT_ACCESS
LEFT JOIN EPT_SEL_SMARTSETS on EPT_SEL_SMARTSETS.PAT_ENC_CSN_ID = MV_DM_PATIENT_ACCESS.PAT_ENC_CSN_ID
WHERE (MV_DM_PATIENT_ACCESS.LOS_NAME LIKE '%NURSE%' OR MV_DM_PATIENT_ACCESS.LOS_NAME LIKE '%NURSING%')
ORDER BY MV_DM_PATIENT_ACCESS.CONTACT_DATE) a
LEFT JOIN
(SELECT * FROM COMBINED_BILLING_DATA) b
ON a.MRN_ID = b.PAT_MRN_ID 
AND (a.HSP_ACCOUNT_ID = b.HSP_ACCOUNT_ID OR a.EXTERNAL_VISIT_ID = b.EXTERNAL_VISIT_ID);")

## AND TO_DATE(a.CONTACT_DATE, 'YYYY-MM-DD') = TO_DATE(b.ORG_SERVICE_DATE, 'YYYY-MM-DD') Removed from left join above

billing_access_index <- glue("CREATE index billing_access_index on COMBINED_NURSE_BILLING_ACCESS_DATA (CONTACT_DATE, ORG_SERVICE_DATE, DISCHARGE_DATE, POST_DATE, DEPARTMENT_ID)")

## Grouped Table execution
tryCatch({
  conn1 <- dbConnect(drv = odbc(), "OAO Cloud DB SoYoun", timeout = 30)
  dbBegin(conn1)
  if(dbExistsTable(conn1, "COMBINED_BILLING_DATA")){
  dbExecute(conn1, billing_drop) 
  }
  dbExecute(conn1, billing_query) 
  dbExecute(conn1, billing_index)
  if(dbExistsTable(conn1, "COMBINED_NURSE_BILLING_ACCESS_DATA")){
    dbExecute(conn1, billing_access_drop) 
  }
  dbExecute(conn1, billing_access_query) 
  dbExecute(conn1, billing_access_index)
  
  dbCommit(conn1)
  dbDisconnect(conn1)
  print("success")
  
},
error = function(err){
  print(paste("Error staging:", err$message))
  dbRollback(conn1)
  dbDisconnect(conn1)
})

```